# Code Generated by Sidekick is for learning and experimentation purposes only.
import streamlit as st
import pandas as pd
from datetime import datetime
from pathlib import Path
import csv
import io

# -------------------------
# App configuration & styles
# -------------------------
st.set_page_config(page_title="SoM AI First Learning Interests & Readiness Survey", page_icon="üìù", layout="centered")

BRAND_CSS = """
<style>
:root {
  --brand: #0f62fe;
  --brand-dark: #0043ce;
  --bg: #fafafa;
  --border: #e0e0e0;
  --text: #161616;
  --muted: #6f6f6f;
  --danger: #da1e28;
  --success: #198038;
}
html, body, [class*="css"]  {
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
}
.container-like {
  max-width: 900px;
  margin: 0 auto;
  background: #fff;
  padding: 16px 20px;
  border: 1px solid var(--border);
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.04);
}
.intro { color: var(--muted); margin-bottom: 12px; }
.hr { height: 1px; background: var(--border); margin: 16px 0; }
.required { color: var(--danger); margin-left: 4px; }
.success { color: var(--success); font-weight: 600; }
.error { color: var(--danger); font-weight: 600; }
.help { color: var(--muted); font-size: 0.9rem; }
</style>
"""
st.markdown(BRAND_CSS, unsafe_allow_html=True)

# -------------------------
# Constants
# -------------------------
CSV_PATH = Path("SoM_GenAI_Survey.csv")

TOOLS_OPTIONS = [
    "ChatGPT / GPT-4 or later",
    "Microsoft Copilot (M365/GitHub/Windows)",
    "Google Gemini",
    "Claude (Anthropic)",
    "Perplexity",
    "Midjourney / Stable Diffusion / DALL¬∑E",
    "Azure OpenAI services",
    "Amazon Bedrock / CodeWhisperer",
    "Databricks / MLflow / AutoML",
    "Other (please specify)",
    "None yet",
]

ROLE_OPTIONS = [
    "Developer/Engineer",
    "Business Analyst (BA)",
    "Tester/QA",
    "Data/ML Engineer or Scientist",
    "Product/Project Manager",
    "Architecture",
    "Design/UX",
    "Operations/Support",
    "Leadership/People Manager",
    "Other",
]

INTERESTS_OPTIONS = [
    "Foundations: prompts, safety, limitations",
    "Productivity: summarization, drafting, research",
    "Prompt engineering for high-quality outputs",
    "Using GenAI in Microsoft 365/Copilot",
    "Using GenAI for coding (GitHub Copilot)",
    "Data privacy, security, and responsible AI",
    "Evaluation of AI outputs (quality/guardrails)",
    "Building apps with APIs (Azure OpenAI, Gemini, Bedrock)",
    "RAG (retrieval augmented generation)",
    "Fine-tuning and embeddings basics",
    "Model selection and cost/performance trade-offs",
    "LLM ops: monitoring, telemetry, and cost control",
    "Testing AI systems (quality, bias, hallucinations)",
    "Integrating AI in SDLC/DevOps",
    "Domain-specific use cases (please specify)",
]

FORMATS_OPTIONS = [
    "Live demo + Q&A (60‚Äì90 min)",
    "Hands-on lab with guided exercises",
    "Role-based breakout",
    "Office hours / coaching",
    "Self-paced materials and quick reference guides",
    "Show-and-tell of internal use cases",
]

TIMING_OPTIONS = ["Mornings", "Midday", "Afternoons", "Evenings"]

COMFORT_OPTIONS = [
    "1 ‚Äì New to AI (need basics)",
    "2 ‚Äì Some exposure",
    "3 ‚Äì Comfortable with common tools",
    "4 ‚Äì Confident (use AI regularly)",
    "5 ‚Äì Advanced (build/evaluate AI solutions)",
]

FREQ_OPTIONS = ["Daily", "Weekly", "Monthly", "Rarely", "Never"]

# Output schema columns
COLUMNS = [
    "timestamp","consent","comfort","tools_used","tools_used_other","tools_frequency",
    "role","role_other","learning_interests","learning_interests_other","implementation_idea_flag",
    "implementation_idea_text","session_formats","timing_preferences","timezone","followup_optin",
    "name","email"
]

# -------------------------
# Utilities: CSV append + load
# -------------------------
def append_row_to_csv(row: dict):
    # Ensure order and defaults for missing keys
    record = {c: row.get(c, "") for c in COLUMNS}
    is_new = not CSV_PATH.exists() or CSV_PATH.stat().st_size == 0
    with CSV_PATH.open("a", newline="", encoding="utf-8") as f:
        w = csv.DictWriter(f, fieldnames=COLUMNS)
        if is_new:
            w.writeheader()
        w.writerow(record)

def df_current() -> pd.DataFrame:
    if CSV_PATH.exists() and CSV_PATH.stat().st_size > 0:
        try:
            return pd.read_csv(CSV_PATH)
        except Exception:
            return pd.DataFrame(columns=COLUMNS)
    return pd.DataFrame(columns=COLUMNS)

def validate_email(email: str) -> bool:
    if not email:
        return True
    import re
    return re.match(r"^[^\s@]+@[^\s@]+\.[^\s@]+$", email) is not None

def multi_select_with_limit(label, options, limit, key):
    selected = st.multiselect(label, options, key=key)
    if len(selected) > limit:
        st.warning(f"Limit reached: You can select up to {limit}.")
        selected = selected[:limit]
        st.session_state[key] = selected
    return selected

# -------------------------
# UI
# -------------------------
st.markdown('<div class="container-like">', unsafe_allow_html=True)
st.title("SoM GenAI Learning Interests & Readiness Survey")
st.markdown(
    '<p class="intro">This brief survey (3‚Äì5 minutes) helps tailor GenAI learning to your needs. '
    "We‚Äôll aggregate results to guide planning; individual responses won‚Äôt be shared outside the planning team.</p>",
    unsafe_allow_html=True,
)

# Optional consent gating (adds to output schema)
consent = st.selectbox(
    "Consent: May we record and aggregate your responses for learning program planning?*",
    options=["Yes", "No"],
    index=0
)

with st.form("survey_form", clear_on_submit=True):
    # Q1 Comfort
    comfort = st.selectbox("Q1. How comfortable are you with using AI?*", options=["Select one"] + COMFORT_OPTIONS)

    # Q2 Tools
    tools = st.multiselect("Q2. Which AI tools have you used? Select all that apply.*", TOOLS_OPTIONS)
    tools_other = ""
    # Mutually exclusive behavior for "None yet"
    if "None yet" in tools and len(tools) > 1:
        tools = ["None yet"]
    if "Other (please specify)" in tools:
        tools_other = st.text_input("Please specify other tool(s)")

    # Q3 Frequency (shown only if not "None yet")
    frequency = ""
    if "None yet" not in tools:
        frequency = st.selectbox("Q3. How often do you use AI tools in your work?", options=["Select one"] + FREQ_OPTIONS)
        st.caption("Shown only if you‚Äôve used any tools.")

    # Q4 Role
    role = st.selectbox("Q4. What is your primary role?*", options=["Select one"] + ROLE_OPTIONS)
    role_other = ""
    if role == "Other":
        role_other = st.text_input("Please specify your role")

    # Q5 Interests with max 5
    interests = multi_select_with_limit(
        "Q5. What do you want to learn more about regarding AI? Select up to 5.*",
        INTERESTS_OPTIONS,
        limit=5,
        key="interests",
    )
    interests_other = ""
    if "Domain-specific use cases (please specify)" in interests:
        interests_other = st.text_input("Please specify domain or topic")

    # Q6 Implementation ideas
    idea_flag = st.radio(
        "Q6. Do you have any ideas on how to implement AI in your role already?*",
        ["Yes", "Not yet", "Prefer to discuss live"],
        horizontal=True,
    )
    idea_text = ""
    if idea_flag == "Yes":
        idea_text = st.text_area(
            "Please describe your idea briefly (what problem, where in workflow, expected benefit).",
            max_chars=800,
            placeholder="Example: Use AI to auto-summarize test results to reduce reporting time by 30%..."
        )

    # Q7 Session formats
    formats = st.multiselect("Q7. Which session formats would be most helpful?*", FORMATS_OPTIONS)

    # Q8 Timing
    timing = st.multiselect("Q8. What times work best for live sessions?", TIMING_OPTIONS)
    timezone = st.text_input("Time zone (optional)")

    # Q9 Follow-up
    followup = st.selectbox("Q9. Are you open to a short follow-up to explore your needs or pilot ideas?",
                            options=["Select one", "Yes", "Maybe", "No"])
    name = ""
    email = ""
    if followup in ("Yes", "Maybe"):
        cols = st.columns(2)
        with cols[0]:
            name = st.text_input("Name (optional)")
        with cols[1]:
            email = st.text_input("Email (optional)")

    submitted = st.form_submit_button("Submit response")

# -------------------------
# Validation & Submission
# -------------------------
status_area = st.empty()

def required_field_checks():
    if consent != "Yes":
        return False, "Please provide consent to proceed."
    if comfort == "Select one":
        return False, "Please select your comfort level."
    if len(tools) == 0:
        return False, "Please select at least one tool option."
    if role == "Select one":
        return False, "Please select your role."
    if len(interests) == 0:
        return False, "Please select at least one learning interest."
    if len(interests) > 5:
        return False, "You can select up to 5 learning interests."
    if idea_flag == "Yes" and not (idea_text or "").strip():
        return False, "Please describe your implementation idea."
    if followup in ("Yes", "Maybe") and email and not validate_email(email.strip()):
        return False, "Please enter a valid email address."
    return True, ""

if submitted:
    ok, msg = required_field_checks()
    if not ok:
        status_area.markdown(f'<p class="error">{msg}</p>', unsafe_allow_html=True)
    else:
        row = {
            "timestamp": datetime.utcnow().isoformat(),
            "consent": consent,
            "comfort": comfort,
            "tools_used": "; ".join(tools),
            "tools_used_other": tools_other.strip() if "Other (please specify)" in tools else "",
            "tools_frequency": "" if "None yet" in tools else (frequency if frequency != "Select one" else ""),
            "role": role,
            "role_other": role_other.strip() if role == "Other" else "",
            "learning_interests": "; ".join(interests),
            "learning_interests_other": interests_other.strip() if "Domain-specific use cases (please specify)" in interests else "",
            "implementation_idea_flag": idea_flag,
            "implementation_idea_text": (idea_text or "").strip() if idea_flag == "Yes" else "",
            "session_formats": "; ".join(formats),
            "timing_preferences": "; ".join(timing),
            "timezone": timezone.strip(),
            "followup_optin": followup if followup != "Select one" else "",
            "name": name.strip(),
            "email": email.strip(),
        }
        try:
            append_row_to_csv(row)
            status_area.markdown('<p class="success">Response recorded. Thank you! You can submit another below.</p>', unsafe_allow_html=True)
        except Exception as e:
            status_area.markdown(f'<p class="error">Could not save your response: {e}</p>', unsafe_allow_html=True)

# -------------------------
# Downloads and live view
# -------------------------
st.markdown('<div class="hr"></div>', unsafe_allow_html=True)
st.subheader("Admin: Data and Exports")

current_df = df_current()
st.caption("Live responses (from CSV):")
st.dataframe(current_df, use_container_width=True, hide_index=True)

# Download latest CSV
csv_buf = io.StringIO()
current_df.to_csv(csv_buf, index=False)
st.download_button(
    "Download CSV",
    data=csv_buf.getvalue(),
    file_name=CSV_PATH.name,
    mime="text/csv",
)

st.markdown("</div>", unsafe_allow_html=True)
